<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teclado Virtual</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .config-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.75);
            z-index: 1000;
            width: 80%;
            max-width: 600px;
            height: 60%;
        }
        .disabled {
            pointer-events: none;
            opacity: 0.25;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const KeyboardLayout = [
            ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
            ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', 'ñ'],
            [',', 'z', 'x', 'c', 'v', 'b', 'n', 'm', '.']
        ];
        const alphaLayout = [
            ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j'],
            ['k', 'l', 'm', 'n', 'ñ', 'o', 'p', 'q', 'r', 's'],
            [',', 't', 'u', 'v', 'w', 'x', 'y', 'z', '.']
        ];

        const vowels = ['a', 'á', 'e', 'é', 'i', 'í', 'o', 'ó', 'u', 'ú', 'A', 'Á', 'E', 'É', 'I', 'Í', 'O', 'Ó', 'U', 'Ú']

        const SymbolsLayoutPage1 = [
            ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
            ['@', '#', '$', '&', '_', '-', '(', ')', '=', '%'],
            ["'", '"', '*', ':', ';', '/', '!', '?', '+']
        ];

        const SymbolsLayoutPage2 = [
            ['£', '€', '¥', '¢', '©', '®', '±', '÷', '¿'],
            ['[', ']', '{', '}', '<', '>', '~', '^', '¡'],
            ['`', '|', '\\', '×', '¬', '§', '¶', '•'],
        ];

        const SpecialKeys = {
            SHIFT: 'SHIFT',
            SPACE: '______',
            BACKSPACE: 'BACKSPACE',
            ENTER: 'ENTER',
            SYMBOLS: 'SYMBOLS',
            TILDE: 'TILDE',
            GUARDAR: 'GUARDAR TEXTO',
            HABLAR: 'HABLAR',
            NOTAS: 'VER NOTAS',
            SALIR: 'SALIR',
            CONFIGURACION: 'CONFIG',
            SUSPENDER: 'SUSPENDER'
        };

        const configKeys = {
            CONFIRMAR: 'Confirmar Cambios',
            SALIR: 'Salir',
            ALPHA: 'Orden Alfabetico',
            VOCAL: 'Resaltar Vocales',
            RESPONSESLOW: '-',
            RESPONSEFAST: '+'
        }
        var keyResponseTime = 20;

        function Keyboard() {
            const [output, setOutput] = React.useState('');
            const [isUpperCase, setUpperCase] = React.useState(false);
            const [isSuspended, setSuspended] = React.useState(false);
            const [showSymbols, setShowSymbols] = React.useState(false);
            const [isTildeActive, setTildeActive] = React.useState(false);
            const [isAlphabetical, setAlphabetical] = React.useState(false);
            const [isVocalHighlight, setVocalHighlight] = React.useState(false);
            const [showConfigPanel, setShowConfigPanel] = React.useState(false);
            const [symbolPage, setSymbolPage] = React.useState(1);
            const [keySize, setKeySize] = React.useState({ width: 40, height: 40 });
            const [activeKey, setActiveKey] = React.useState(null);
            const [isSpeaking, setIsSpeaking] = React.useState(false);
            const timerRefs = React.useRef({});
            const containerRef = React.useRef(null);
            
            React.useEffect(() => {
                const updateKeySize = () => {
                    if (containerRef.current) {
                        const containerWidth = containerRef.current.offsetWidth;
                        const containerHeight = containerRef.current.offsetHeight;
                        const keyWidth = Math.floor(containerWidth / 12) - 4;
                        const keyHeight = Math.floor(containerHeight / 6) - 4;
                        setKeySize({ width: keyWidth, height: keyHeight });
                    }
                };

                updateKeySize();
                window.addEventListener('resize', updateKeySize);
                return () => window.removeEventListener('resize', updateKeySize);
            }, []);

            const handleKeyPress = React.useCallback((key) => {
                if (key === SpecialKeys.SUSPENDER) {
                    setSuspended(!isSuspended);
                }
                else if(!isSuspended){
                    if (key === SpecialKeys.SHIFT) {
                        if (showSymbols) {
                            if (symbolPage === 1) {
                                setSymbolPage(2);
                            } else if (symbolPage === 2) {
                                setSymbolPage(1);
                            }
                        } else {
                            setUpperCase(prev => !prev);
                        }
                    } else if (key === SpecialKeys.SPACE) {
                        setOutput(prev => prev + ' ');
                    } else if (key === SpecialKeys.BACKSPACE) {
                        setOutput(prev => prev.slice(0, -1));
                    } else if (key === SpecialKeys.ENTER) {
                        setOutput(prev => prev + '\n');
                    } else if (key === SpecialKeys.SYMBOLS) {
                        if (showSymbols) {
                            setShowSymbols(false); // Volver a letras
                        } else {
                            setShowSymbols(true);
                            setSymbolPage(1); // siempre vuelve a simbolos 1
                        }
                    } else if (key === SpecialKeys.TILDE) {
                        setTildeActive(prev => !prev);
                    } else if (key === SpecialKeys.GUARDAR) {
                        saveTextToFile(output);
                    } else if (key === SpecialKeys.HABLAR) {
                        speakText();
                    } else if (key === SpecialKeys.CONFIGURACION) {
                        setShowConfigPanel(true);
                    }/* else if (key === configKeys.CONFIRMAR) {
                        confirmConfigChanges();
                    } */else if (key === configKeys.SALIR) {
                        closeConfigPanel();
                    } else if (key === configKeys.ALPHA) {
                        setAlpha();
                    } else if (key === configKeys.VOCAL) {
                        setVocalHL();
                    } else if (key === configKeys.RESPONSESLOW) {
                        setKeyResponseTimeSlow();
                    } else if (key === configKeys.RESPONSEFAST) {
                        setKeyResponseTimeFast();
                    } else {
                        let modifiedKey = key;
                        if (isTildeActive) {
                            if (isUpperCase) {
                                modifiedKey = { 'a': 'Á', 'e': 'É', 'i': 'Í', 'o': 'Ó', 'u': 'Ú' }[key.toLowerCase()] || key;
                            } else {
                                modifiedKey = { 'a': 'á', 'e': 'é', 'i': 'í', 'o': 'ó', 'u': 'ú' }[key.toLowerCase()] || key;
                            }
                            setTildeActive(false);
                        } else {
                            if (isUpperCase) {
                                modifiedKey = { 'a': 'A', 'e': 'E', 'i': 'I', 'o': 'O', 'u': 'U' }[key.toLowerCase()] || key;
                            } else {
                                modifiedKey = { 'a': 'a', 'e': 'e', 'i': 'i', 'o': 'o', 'u': 'u' }[key.toLowerCase()] || key;
                            }
                        }
                        setOutput(prev => prev + (isUpperCase ? modifiedKey.toUpperCase() : modifiedKey));
                        if (isUpperCase) setUpperCase(false);
                    }
                setActiveKey(null);
            }
            }, [isUpperCase, isSuspended, showSymbols, symbolPage, isTildeActive, output]);

            const handleKeyEnter = React.useCallback((key, uniqueId) => {
                setActiveKey(key);
                let progress = 0;
                timerRefs.current[uniqueId] = setInterval(() => {
                    progress += 100/(keyResponseTime*2.5);
                    if (progress >= 100) {
                        clearInterval(timerRefs.current[uniqueId]);
                        handleKeyPress(key);
                        document.querySelector(`.progress-bar-bottom-${uniqueId}`).style.width = '0%';
                        document.querySelector(`.progress-bar-top-${uniqueId}`).style.width = '0%';
                        document.querySelector(`.key-${uniqueId}`).classList.add('flash');
                        setTimeout(() => {
                            document.querySelector(`.key-${uniqueId}`).classList.remove('flash');
                        }, 300);
                    } else {
                        document.querySelector(`.progress-bar-bottom-${uniqueId}`).style.width = `${progress}%`;
                        document.querySelector(`.progress-bar-top-${uniqueId}`).style.width = `${progress}%`;
                    }
                }, keyResponseTime);
            }, [handleKeyPress]);

            const handleKeyLeave = React.useCallback((uniqueId) => {
                if (timerRefs.current[uniqueId]) {
                    clearInterval(timerRefs.current[uniqueId]);
                }
                setActiveKey(null);
                document.querySelector(`.progress-bar-bottom-${uniqueId}`).style.width = '0%';
                document.querySelector(`.progress-bar-top-${uniqueId}`).style.width = '0%';
            }, []);

            const renderKey = (key, index, rowIndex, width = keySize.width, height = keySize.height , extraClass = '', onClick = () => { }) => {
                const uniqueId = `${rowIndex}-${index}`;

                const getKeyDisplay = (key) => {
                    if (key === SpecialKeys.BACKSPACE) {
                        return '←';
                    } else if (key === SpecialKeys.SYMBOLS) {
                        return showSymbols ? 'abc' : '123';
                    } else if (key === SpecialKeys.SHIFT) {
                        return showSymbols ? (symbolPage === 1 ? '1/2' : '2/2') : 'SHIFT';
                    } else if (key === SpecialKeys.TILDE) {
                        return 'TILDE';
                    } else if (key === SpecialKeys.GUARDAR) {
                        return 'GUARDAR';
                    } else if (key === SpecialKeys.HABLAR) {
                        return 'HABLAR';
                    } else {
                        let displayKey = key;
                        if (isTildeActive) {
                            displayKey = {
                                'a': 'á', 'e': 'é', 'i': 'í', 'o': 'ó', 'u': 'ú',
                                'A': 'Á', 'E': 'É', 'I': 'Í', 'O': 'Ó', 'U': 'Ú'
                            }[key] || key;
                        }
                        return isUpperCase ? displayKey.toUpperCase() : displayKey;
                    }
                };

                const fontSize = Math.min(keySize.width, keySize.height) * 0.3;

                return (
                    <div className={`key-container relative flex items-center justify-center text-white ${extraClass}}`} key={uniqueId} style={{ width: `${width}px`, height: `${height}px` }}>
                        <div className={`progress-bar absolute top-0 right-0 h-[14%] bg-[#4caf50] transition-width pointer-events-none progress-bar-bottom progress-bar-bottom-${uniqueId}`}></div>
                        <div className={`progress-bar absolute bottom-0 left-0 h-[14%] bg-[#4caf50] transition-width pointer-events-none progress-bar-top progress-bar-top-${uniqueId}`}></div>
                        <button
                        className={`key-${uniqueId}
                            ${Object.values(SpecialKeys).includes(key) ? 
                                (key === SpecialKeys.SUSPENDER && isSuspended ? 'bg-[#ff0000] hover:bg-[#cc0000]' : 'bg-[#006040] hover:bg-[#008070]') :
                                (isVocalHighlight && vowels.includes(key) ? 'bg-[#600000] hover:bg-[#700000]' : 'bg-[#001820] hover:bg-[#003030]')
                            } border rounded shadow hover:bg-[#003030] hover:border hover:border-[#4caf50] transition-colors flex items-center justify-center`}
                            onMouseEnter={() => handleKeyEnter(key, uniqueId)}
                            onMouseLeave={() => handleKeyLeave(uniqueId)}
                            onClick={() => {
                                handleKeyPress(key);
                                //onClick();
                            }}
                            style={{ width: '100%', height: '100%', fontSize: `${fontSize}px` }}
                        >
                            {getKeyDisplay(key)}
                        </button>
                    </div>
                );
            };

            const speakText = () => {
                if (isSpeaking) return; 
                setIsSpeaking(true);
                const utterance = new SpeechSynthesisUtterance(output);
                utterance.lang = 'es-ES';
                utterance.onend = () => setIsSpeaking(false); // Marca el fin de la síntesis
                speechSynthesis.speak(utterance);
            };

            const currentSymbolsLayout = symbolPage === 1 ? SymbolsLayoutPage1 : SymbolsLayoutPage2;

            const saveTextToFile = (text) => {
                const element = document.createElement("a");
                const file = new Blob([text], { type: 'text/plain' });
                element.href = URL.createObjectURL(file);
                element.download = "output.txt";
                document.body.appendChild(element);
                element.click();
            };

            const closeConfigPanel = () => {
                setShowConfigPanel(false);
            };
            /*
            const confirmConfigChanges = () => {
                closeConfigPanel();
            };
            */
            const setAlpha = () => {
                setAlphabetical(!isAlphabetical);
            };

            const setVocalHL = () => {
                setVocalHighlight(!isVocalHighlight);
            };
            
            const setKeyResponseTimeSlow = () => {
                if(keyResponseTime>5)
                    keyResponseTime--;
            };
            const setKeyResponseTimeFast = () => {
                if(keyResponseTime<50)
                    keyResponseTime++;
            };
            

            const renderConfigPanel = () => (
                <div className="config-panel">
                    <h2 className="text-center text-2xl font-bold mb-4" style={{ color: '#ffff00' }}>
                        Configuración del Teclado
                    </h2>
                    <div className="flex flex-col items-center gap-5 mr-8">
                        <div className="flex flex-row items-center gap-2 rounded-lg">
                            {renderKey(configKeys.ALPHA, 1,'extra', keySize.width * 1.5, keySize.height * 1,'extra-button')}
                            {renderKey(configKeys.VOCAL, 2,'extra', keySize.width * 1.5, keySize.height * 1,'extra-button')}
                        </div>
                        <div className="flex flex-row items-center gap-3">
                            {renderKey(configKeys.RESPONSESLOW, 3, 'extra', keySize.width * 1.5, keySize.height * 0.5, 'extra-button')}
                            <div style={{ fontSize: '30px', margin: '0 10px' }}>
                                {keyResponseTime}
                            </div>
                            {renderKey(configKeys.RESPONSEFAST, 4, 'extra', keySize.width * 1.5, keySize.height * 0.5, 'extra-button')}
                        </div>
                        {renderKey(configKeys.SALIR, 5,'extra', keySize.width * 1.75, keySize.height * 0.75,'extra-button')}
                    </div>
                </div>
            );

            const currentKeyboardLayout = isAlphabetical ? alphaLayout : KeyboardLayout;

            return (
                <div className="flex flex-col items-center p-4 bg-black rounded-lg shadow-md h-screen" ref={containerRef}>
                    {showConfigPanel && renderConfigPanel()}
                    <div className={`flex flex-col items-center w-full ${showConfigPanel ? 'disabled' : ''}`}>
                        <div className="flex items-center w-full mb-4">
                            <div className="ml-5 mr-5">
                                {renderKey(SpecialKeys.HABLAR, 0, 'extra', keySize.width * 1.5, keySize.height * 1.5, 'extra-button', speakText)}
                            </div>
                            <textarea
                                value={output}
                                onChange={(e) => setOutput(e.target.value)}
                                className="p-2 border rounded resize-none"
                                style={{
                                    fontSize: '40px',
                                    width: '50vw',
                                    height: '24vh'
                                }}
                                placeholder="Tu texto aparecerá aquí..."
                            />
                            <div className="grid grid-cols-2 gap-2 ml-4">
                                {renderKey(SpecialKeys.SUSPENDER, 1, 'extra', keySize.width * 2, keySize.height * 0.75, 'extra-button')}
                                {renderKey(SpecialKeys.SALIR, 2, 'extra', keySize.width * 2, keySize.height * 0.75, 'extra-button')}
                                {renderKey(SpecialKeys.CONFIGURACION, 3, 'extra', keySize.width * 2, keySize.height * 0.75, 'extra-button')}
                                {renderKey(SpecialKeys.NOTAS, 4, 'extra', keySize.width * 2, keySize.height * 0.75, 'extra-button')}
                            </div>
                        </div>
                        <div className="grid gap-2 w-full justify-center ml-5">
                            {(showSymbols ? currentSymbolsLayout : currentKeyboardLayout).map((row, rowIndex) => (
                                <div key={rowIndex} className="flex justify-center gap-2">
                                    {row.map((key, index) => renderKey(key, index, rowIndex, keySize.width * 1.12))}
                                </div>
                            ))}
                            <div className="flex justify-center gap-2 mt-1">
                                {renderKey(SpecialKeys.TILDE, 0, 'special', keySize.width * 1.25)}
                                {renderKey(SpecialKeys.SHIFT, 1, 'special', keySize.width * 1.5)}
                                {renderKey(SpecialKeys.SYMBOLS, 2, 'special', keySize.width * 1.25)}
                                {renderKey(SpecialKeys.SPACE, 3, 'special', keySize.width * 3)}
                                {renderKey(SpecialKeys.BACKSPACE, 4, 'special', keySize.width * 1.25)}
                                {renderKey(SpecialKeys.ENTER, 5, 'special', keySize.width * 1.5)}
                                {renderKey(SpecialKeys.GUARDAR, 6, 'special', keySize.width * 1.5)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Keyboard />, document.getElementById('root'));
    </script>
</body>

</html>
